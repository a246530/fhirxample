<html lang="en"><head>
    <!-- Required meta tags -->
   <meta charset="utf-8">
   <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
   <title>Temp</title>
   <!-- Bootstrap core CSS -->
   <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
   <style>   
        .links line {
          stroke: #999;
          stroke-opacity: 0.6;
        }

        .nodes circle {
          stroke: #fff;
          stroke-width: 1.5px;
        }

        text {
          font-family: sans-serif;
          font-size: 10px;
        }
   </style>
   <!-- Custom styles for this template -->
 </head>
 <body class="bg-light">
   <main role="main" class="container">
     <div id="app">
       <div id="patient">
         <h3>Patient Demo</h3>
         <div   v-if="patients">
                {{ patients.birthDate }}
               {{ patients.name[0].given[0] }}
               {{ patients.name[0].family }}
         </div>
         <div v-else>Loading</div>
       </div>
     </div>
   </main>
   <svg width="1600" height="800"></svg>
    <script src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://unpkg.com/vue@next"></script>
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" crossorigin="anonymous"></script>
<script src="https://combinatronics.com/smart-on-fhir/client-js/master/dist/build/fhir-client.js"></script>
   <script type="text/javascript">
       const getSmartClient = () =>
          new Promise((resolve, reject) => {
            FHIR.oauth2.ready(function(smart, err) {
                if (err) {
                  reject(err);
                }
                resolve(smart);
              });
          });

        const fhirapp = {
           data() {
             return {
                patients : null
                ,encounters : null
                ,conditions : null
                ,selectedPatient : null
                ,loading: true
                ,error: null
             }
           },
            async mounted() {
               const smart = await getSmartClient();
                this.patients=await smart.patient.read();
                //console.log(this.patients);
                var fdc = {
                    nodes:[
                    ],
                    links:[
                    ]
                };
                this.conditions = await this.makeSmartRequest(smart,"Condition");
                console.log(this.conditions);
                this.conditions.entry.forEach(condition=>{
                    let rid=condition.resource.encounter.reference.replace("Encounter/", "");
                    fdc.nodes.push({ id : condition.resource.code.text , group : 1, rid: rid});
                });
                this.encounters = await this.makeSmartRequest(smart,"Encounter");  
                this.encounters.entry.forEach(encounter=>{
                    let idExist=false;
                    let idExistsIndex=null;
                    for(let c=0;c<fdc.nodes.length;c++){
                        if(fdc.nodes[c].id==encounter.resource.type[0].text){
                            console.log("foundone");
                            ifExists=true;
                            idExistsIndex=c;
                            break;
                        }
                    }
                    if(idExist){
                        fdc.nodes[idExistsIndex].rid.push(encounter.resource.id);
                    }else{
                        fdc.nodes.push({id : encounter.resource.type[0].text , group : 2, rid: [encounter.resource.id]});
                    }
                });
                console.log(fdc);
               
                
          },
           methods: {
             async makeSmartRequest(smart,resource) {
                 let fhirResource = await smart.patient.request(resource);
                 //console.log(fhirResource);
                 return fhirResource;
             }
             ,async onError() {
                console.log("There was a problem");
             }
           }
         }
       Vue.createApp(fhirapp).mount('#app'); 
      
   </script>
</body></html>
